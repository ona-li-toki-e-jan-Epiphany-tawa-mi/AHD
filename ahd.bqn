#!/usr/bin/env bqn

# This file is part of AHD.
#
# Copyright (c) 2024 ona-li-toki-e-jan-Epiphany-tawa-mi
#
# AHD is free software: you can redistribute it and/or modify it under the terms
# of the GNU General Public License as published by the Free Software
# Foundation, either version 3 of the License, or (at your option) any later
# version.
#
# AHD is distributed in the hope that it will be useful, but WITHOUT ANY
# WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR
# A PARTICULAR PURPOSE. See the GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License along with
# AHD. If not, see <https://www.gnu.org/licenses/>.

# AHD - A HexDumper. Hex dump utility.

################################################################################
# Hexdump Generator                                                            #
################################################################################

# Splits a list into groups of a specified size. Leftover data that could not
# fit in will be placed into the last group.
# ğ•©: list.
# ğ•¨: number - size.
# â†: list of lists.
GroupEvery â† {ğ•©âŠ”ËœâŒŠğ•¨Ã·Ëœâ†•â‰ ğ•©}

# Pairs each element in a list with a number starting at 0 and increasing by n
# for it's index (i.e. âŸ¨âŸ¨0,'a'âŸ©,âŸ¨5,'b'âŸ©,âŸ¨10,'c'âŸ©âŸ© â† 5 ğ•Š "abc").
# ğ•©: list.
# ğ•¨: number - step.
# â†: numberâ‹ˆelement list.
EnumerateBy â† {ğ•©â‹ˆÂ¨Ëœğ•¨Ã—â†•â‰ ğ•©}

# Converts a number to it's uppercase hexidecimal representation as a string of
# a specified length, left-padding with zeros.
# ğ•©: number - to convert.
# ğ•¨: number - length.
# â†: string.
Hexify â† (â¥ŠâŸœ16)âŠ¸{"0123456789ABCDEF"âŠËœğ•¨|âŒŠÃ·`âŒ¾âŒ½ğ•¨Â«Ëœ<ğ•©}

# Returns whether the given number(s), converted to character(s), represent
# printable ASCII.
# ğ•©: number or number list.
# â†: boolean or boolean list.
IsDisplayable â† (32âŠ¸â‰¤)âˆ§(126âŠ¸â‰¥)

bytesPerLine â† 16

# Prints out a hexdump of the given bytes.
# ğ•©: number list, where 0â‰¤numberâ‰¤255 .
Hexdump â† {
    lineNumberString â† 7 Hexify âŠ‘ğ•©
    bytesHexString â† âˆ¾âŸœ(' 'â¥ŠËœ(3Ã—bytesPerLine)-â‰ )âˆ¾(' 'âˆ¾2âŠ¸Hexify)Â¨1âŠ‘ğ•©
    bytesCharacterString â† @+IsDisplayableâ—¶âŸ¨' '-@,âŠ¢âŸ©Â¨1âŠ‘ğ•©

    â€¢Out lineNumberString âˆ¾ ':' âˆ¾ bytesHexString âˆ¾ " |" âˆ¾ bytesCharacterString âˆ¾ "|"
}Â¨ bytesPerLine EnumerateBy bytesPerLineâŠ¸GroupEvery

################################################################################
# Command Line Interface                                                       #
################################################################################

# Joins a string list into a string with newlines in-between.
# ğ•©: string list.
# â†: string.
Unlines â† (âˆ¾âŸœ(@+10)âŠ¸âˆ¾)Â´

help â† Unlines âŸ¨
    "Usage:",
    "  "âˆ¾â€¢nameâˆ¾" [options...] FILE",
    "",
    "Displays FILE contents in hexidecimal.",
    "",
    "Options:",
    "  --help       display this help information and exits.",
    "  --version    display version and exits.",
    "  --license    display license and exits.",
âŸ©


version â† "ahd 0.1.6"

license â† Unlines âŸ¨
    "Copyright (C) 2024 ona-li-toki-e-jan-Epiphany-tawa-mi.",
    "",
    "This program is free software: you can redistribute it and/or modify it",
    "under the terms of the GNU General Public License as published by the Free",
    "Software Foundation, either version 3 of the License, or (at your option)",
    "any later version.",
    "",
    "This program is distributed in the hope that it will be useful, but WITHOUT",
    "ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or",
    "FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License for",
    "more details.",
    "",
    "You should have received a copy of the GNU General Public License along",
    "with this program. If not, see http://www.gnu.org/licenses/.",
    "",
    "Source (paltepuk):",
    "  https://http://paltepuk.xyz/cgit/AHD.git/about/",
    "  http://oytjumugnwsf4g72vemtamo72vfvgmp4lfsf6wmggcvba3qmcsta.b32.i2p/cgit/AHD.git/about/",
    "  http://4blcq4arxhbkc77tfrtmy4pptf55gjbhlj32rbfyskl672v2plsmjcyd.onion/cgit/AHD.git/about/",
    "",
    "Source (GitHub):",
    "  https://github.com/ona-li-toki-e-jan-Epiphany-tawa-mi/AHD/"
âŸ©

Error â† â€¢Out "Error: "âŠ¸âˆ¾

fileâ†0
codeGeneratorLanguageâ†0

# TODO: add single character options.
ParseArguments â† {
    []: @;
    ğ•©: (1â†“ğ•©) {
        ğ•¨ğ•Š[]: ParseArguments ğ•¨ ;
        ğ•¨ğ•Š"--help": â€¢Out help â‹„ â€¢Exit 0 ;
        ğ•¨ğ•Š"--version": â€¢Out version â‹„ â€¢Exit 0 ;
        ğ•¨ğ•Š"--license": â€¢Out license â‹„ â€¢Exit 0 ;
        ğ•¨ğ•Šğ•©: '-'â‰¡âŠ‘ğ•© ? Error "unknown option '"âˆ¾ğ•©âˆ¾"'" â‹„ â€¢Exit 1;
              0â‰¡file ? file â†© ğ•© â‹„ ParseArguments ğ•¨ ;
                       Error "Only one file may be specified but multiple were present"
                       â‹„ â€¢Exit 1
    } âŠ‘ğ•©
}

# Returns the contents of a file as bytes.
# ğ•©: string - file name.
# â†: number list.
ReadBytes â† @-Ëœâ€¢file.MapBytes

main â† {
    ParseArguments â€¢args

    # TODO: add C code generator.

    { 0: Error "No file specified" â‹„ â€¢Out help â‹„ â€¢Exit 1 ;
      ğ•©: Hexdump ReadBytes file
    } file
}
