#!/usr/bin/env bqn

# This file is part of AHD.
#
# Copyright (c) 2024 ona-li-toki-e-jan-Epiphany-tawa-mi
#
# AHD is free software: you can redistribute it and/or modify it under the terms
# of the GNU General Public License as published by the Free Software
# Foundation, either version 3 of the License, or (at your option) any later
# version.
#
# AHD is distributed in the hope that it will be useful, but WITHOUT ANY
# WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR
# A PARTICULAR PURPOSE. See the GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License along with
# AHD. If not, see <https://www.gnu.org/licenses/>.

# AHD - A HexDumper. Hex dump utility.

################################################################################
# Utilities                                                                    #
################################################################################

# Converts a number to it's uppercase hexidecimal representation as a string of
# a specified length, left-padding with zeros.
# ğ•©: number - to convert.
# ğ•¨: number - length.
# â†: string.
Hexify â† (â¥ŠâŸœ16)âŠ¸{"0123456789ABCDEF"âŠËœğ•¨|âŒŠÃ·`âŒ¾âŒ½ğ•¨Â«Ëœ<ğ•©}

# Splits a list into groups of a specified size. Leftover data that could not
# fit in will be placed into the last group.
# ğ•©: list.
# ğ•¨: number - size.
# â†: list of lists.
GroupEvery â† {ğ•©âŠ”ËœâŒŠğ•¨Ã·Ëœâ†•â‰ ğ•©}

################################################################################
# Hexdump Generator                                                            #
################################################################################

hexdumpBytesPerLine â† 16

# Pairs each element in a list with a number starting at 0 and increasing by n
# for it's index (i.e. âŸ¨âŸ¨0,'a'âŸ©,âŸ¨5,'b'âŸ©,âŸ¨10,'c'âŸ©âŸ© â† 5 ğ•Š "abc").
# ğ•©: list.
# ğ•¨: number - step.
# â†: numberâ‹ˆelement list.
EnumerateBy â† {ğ•©â‹ˆÂ¨Ëœğ•¨Ã—â†•â‰ ğ•©}

# Returns whether the given number(s), converted to character(s), represent
# printable ASCII.
# ğ•©: number or number list.
# â†: boolean or boolean list.
IsDisplayable â† (32âŠ¸â‰¤)âˆ§(126âŠ¸â‰¥)

# Prints out a hexdump of the given bytes.
# ğ•©: number list, where 0â‰¤numberâ‰¤255.
Hexdump â† {
    lineNumberString â† 7 Hexify âŠ‘ğ•©
    bytesHexString â† âˆ¾âŸœ(' 'â¥ŠËœ(3Ã—hexdumpBytesPerLine)-â‰ )âˆ¾(' 'âˆ¾2âŠ¸Hexify)Â¨1âŠ‘ğ•©
    bytesCharacterString â† @+IsDisplayableâ—¶âŸ¨' '-@,âŠ¢âŸ©Â¨1âŠ‘ğ•©

    â€¢Out lineNumberString âˆ¾ ':' âˆ¾ bytesHexString âˆ¾ " |" âˆ¾ bytesCharacterString âˆ¾ "|"
}Â¨ hexdumpBytesPerLine EnumerateBy hexdumpBytesPerLineâŠ¸GroupEvery

################################################################################
# C Code Generator                                                             #
################################################################################

cBytesPerLine â† 12

# Prints out code in C for embedding the given bytes in a program.
# ğ•©: number list, where 0â‰¤numberâ‰¤255.
GenerateC â† {
    dataLength â† 0

    â€¢Out "unsigned char data[] = {"
    {
        dataLength +â†© â‰ ğ•©
        â€¢Out "   "âˆ¾âˆ¾(" 0x"âˆ¾','âˆ¾Ëœ2âŠ¸Hexify)Â¨ğ•©
    }Â¨ cBytesPerLine GroupEvery ğ•©
    â€¢Out "}"

    â€¢Out "unsigned int data_length = "âˆ¾(â€¢Fmt dataLength)âˆ¾";"
}

################################################################################
# BQN Code Generator                                                           #
################################################################################

bqnBytesPerLine â† 14

# Prints out code in BQN for embedding the given bytes in a program.
# ğ•©: number list, where 0â‰¤numberâ‰¤255.
GenerateBQN â† {
    â€¢Out "data â† âŸ¨"
    (â€¢Outâˆ˜("   "âŠ¸âˆ¾âˆ¾)((' 'âŠ¸âˆ¾âˆ¾âŸœ',')â€¢Fmt)Â¨)Â¨ bqnBytesPerLine GroupEvery ğ•©
    â€¢Out "âŸ©"
}

################################################################################
# Command Line Interface                                                       #
################################################################################

help â† "Usage:
  "âˆ¾â€¢nameâˆ¾" [options...] [FILE]

Displays FILE contents in hexidecimal.

If FILE is not specified, reads input from stdin.

Options:
  -h, --help      display this help information and exits.
  -v, --version   display version and exits.
  -l, --license   display license and exits.

  -c, --code-generator <langauge>
    Outputs code, instead of a hexdump, to bake the data into a program.
    Supported Languages: c, bqn"

version â† "ahd 0.1.6"

license â† "Copyright (C) 2024 ona-li-toki-e-jan-Epiphany-tawa-mi.

This program is free software: you can redistribute it and/or modify it under
the terms of the GNU General Public License as published by the Free Software
Foundation, either version 3 of the License, or (at your option) any later
version.

This program is distributed in the hope that it will be useful, but WITHOUT ANY
WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A
PARTICULAR PURPOSE. See the GNU General Public License for more details.

You should have received a copy of the GNU General Public License along with
this program. If not, see http://www.gnu.org/licenses/.

Source (paltepuk):
  https://paltepuk.xyz/cgit/AHD.git/about/
  http://oytjumugnwsf4g72vemtamo72vfvgmp4lfsf6wmggcvba3qmcsta.b32.i2p/cgit/AHD.git/about/
  http://4blcq4arxhbkc77tfrtmy4pptf55gjbhlj32rbfyskl672v2plsmjcyd.onion/cgit/AHD.git/about/

Source (GitHub):,
  https://github.com/ona-li-toki-e-jan-Epiphany-tawa-mi/AHD/"

# Outputs an error message, some help information, and then exits.
# ğ•©: string - the error message.
Error â† {
    â€¢Out "Error: "âˆ¾ğ•©
    â€¢Out "Try '"âˆ¾â€¢nameâˆ¾" --help' for more information"
    â€¢Exit 1
}

# Argument parser code generator state.
# ğ•©: string list - remaining command line arguments.
ParseCodeGenerator â† {
    []: Error "--code-generator specified without argument" â‹„ â€¢Exit 1 ;
    ğ•©: ((1âŠ¸â†“){
        ğ•¨ğ•Š"c": codeGeneratorLanguageâ†©ğ•© â‹„ ParseArguments ğ•¨ ;
        ğ•¨ğ•Š"bqn": codeGeneratorLanguageâ†©ğ•© â‹„ ParseArguments ğ•¨ ;
        Â·ğ•Šğ•©: Error "Unknown language '"âˆ¾ğ•©âˆ¾"' specified with --code-generator"
    }âŠ‘) ğ•©
}

# Attempts to set the file extracted from command line arguments.
# ğ•©: string.
SetFile â† {
    0â‰¢file ? Error "Only one file may be specified but multiple were present" ;
    file â†© ğ•©
}

# Argument parser post "--" argument file state.
# ğ•©: string list - remaining command line arguments.
ParseAllAsFiles â† {
    []: @ ;
    ğ•©: (1âŠ¸â†“{
        ğ•¨ğ•Š[]: ParseAllAsFiles ğ•¨ ;
        ğ•¨ğ•Šğ•©: SetFile ğ•© â‹„ ParseAllAsFiles ğ•¨
    }âŠ‘) ğ•©
}

# Argument parser file state.
# ğ•©: string list - remaining command line arguments.
ParseFile â† {
    []: @ ;
    ğ•©: (1âŠ¸â†“{
        ğ•¨ğ•Š[]: ParseArguments ğ•¨ ;
        ğ•¨ğ•Šğ•©: SetFile ğ•© â‹„ ParseArguments ğ•¨
    }âŠ‘) ğ•©
}

# Argument parser short options state.
# ğ•©: string - short options without leading '-'.
# ğ•¨: string list - remaining command line arguments.
ParseShortOptions â† {
    Â·ğ•Š[]: Error "ParseShortOptions: unreachable";
    ğ•¨ğ•Šğ•©: ğ•¨ {
        Â·ğ•Š'h'â€¿Â·: â€¢Out help â‹„ â€¢Exit 0 ;
        Â·ğ•Š'v'â€¿Â·: â€¢Out version â‹„ â€¢Exit 0 ;
        Â·ğ•Š'l'â€¿Â·: â€¢Out license â‹„ â€¢Exit 0 ;
        ğ•¨ğ•Š'c'â€¿[]: ParseCodeGenerator ğ•¨;
        ğ•¨ğ•Š'c'â€¿rest: ParseCodeGenerator ğ•¨âˆ¾Ëœ<rest
    } (âŠ‘â‹ˆ1âŠ¸â†“) ğ•©
}

# Recursively parses a list of command line arguments with a finite state
# machine.
# ğ•©: string list - remaining command line arguments.
ParseArguments â† {
    []: @ ;
    ğ•©: (1âŠ¸â†“{
        Â·ğ•Š[]: ParseArguments ğ•¨ ;
        Â·ğ•Š"--help": â€¢Out help â‹„ â€¢Exit 0 ;
        Â·ğ•Š"--version": â€¢Out version â‹„ â€¢Exit 0 ;
        Â·ğ•Š"--license": â€¢Out license â‹„ â€¢Exit 0 ;
        ğ•¨ğ•Š"--code-generator": ParseCodeGenerator ğ•¨ ;
        ğ•¨ğ•Š"--": ParseAllAsFiles ğ•¨ ;
        ğ•¨ğ•Š"-": ParseFile ğ•¨âˆ¾Ëœ<ğ•© ;
        ğ•¨ğ•Šğ•©: "--"â‰¡2â†‘ğ•© ? Error "Unknown option '"âˆ¾ğ•©âˆ¾"'"
            ; '-'â‰¡âŠ‘ğ•© ? ğ•¨ ParseShortOptions 1â†“ğ•©
            ; ParseFile ğ•¨âˆ¾Ëœ<ğ•©
    }âŠ‘) ğ•©
}

# Returns the contents of a file as bytes.
# ğ•©: string - file name.
# â†: number list.
ReadFileBytes â† @-Ëœâ€¢file.MapBytes

# Returns the contents of stdin as bytes. Blocks until EOF is reached.
# ğ•©: any - dummy value to make this a function.
# â†: number list.
ReadStdinBytes â† { ğ•©:
    # Cursed, but â€¢term.CharB reads only one character at a time and I couldn't
    # find a better way to read from stdin.
    result â† âŸ¨âŸ©
    @â€¢_while_{ğ•©: result âˆ¾â†© â€¢term.CharB @ â‹„ 0â‰¢Â¯1âŠ‘result}@
    # Converts to bytes, dropping the 0 from â€¢term.CharB.
    @-ËœÂ¯1â†“result
}

# File to read from. Set by ParseArguments. 0 means no file.
fileâ†0
# Code generator language to use. Set by ParseArguments. 0 means output hexdump.
codeGeneratorLanguageâ†0

main â† {
    ParseArguments â€¢args

    data â† âŸ¨âŸ©
    { 0â‰¡file ? data â†© ReadStdinBytes @
    ; â€¢file.Exists file ? data â†© ReadFileBytes file
    ; Error "Failed to open '"âˆ¾fileâˆ¾"': no such file or directory"
    }

    { 0: Hexdump data ;
      "c": GenerateC data ;
      "bqn": GenerateBQN data
    } codeGeneratorLanguage
}
