#!/usr/bin/env bqn

# This file is part of AHD.
#
# Copyright (c) 2024 ona-li-toki-e-jan-Epiphany-tawa-mi
#
# AHD is free software: you can redistribute it and/or modify it under the terms
# of the GNU General Public License as published by the Free Software
# Foundation, either version 3 of the License, or (at your option) any later
# version.
#
# AHD is distributed in the hope that it will be useful, but WITHOUT ANY
# WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR
# A PARTICULAR PURPOSE. See the GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License along with
# AHD. If not, see <https://www.gnu.org/licenses/>.

# AHD integration testing script.
#
# Run './test.bqn' to run tests.
# Run './test.bqn' to regenerate tests.

newline â† @+10

sourceDirectory â† "tests/sources"
outputDirectory â† "tests/outputs"

# Runs AHD with the given arguments.
# ğ•©: string list.
# â†: numberâ€¿stringâ€¿string - exitCodeâ€¿stdoutâ€¿stderr from AHD.
RunAHD â† {
    command â† "bqn"â€¿"ahd.bqn"âˆ¾ğ•©
    â€¢Out "+ "âˆ¾(âˆ¾âŸœ" "âŠ¸âˆ¾)Â´command
    â€¢SH command
}

# Generates a report from the output of AHD that can be used for comparison in
# tests.
# ğ•©: numberâ€¿stringâ€¿strin - exitCodeâ€¿stdoutâ€¿stderr from AHD.
# â†: string.
GenerateReport â† {
    exitCodeâ€¿stdoutâ€¿stderr â† ğ•©

    reportâ†":exitcode "âˆ¾(â€¢Fmt exitCode)âˆ¾newline
    reportâ†©reportâˆ¾":stdout"âˆ¾newlineâˆ¾stdout
    reportâ†©reportâˆ¾":stderr"âˆ¾newlineâˆ¾stderr
    report
}

# Takes a file name and arguments used in the AHD command and generates a path
# to a corresponding and unique file in the output directory.
# ğ•©: string - file name.
# ğ•¨: string list - arguments.
# â†: string.
OutputFile â† {
    path â† outputDirectory â€¢file.At ğ•©

    ğ•¨ { 0â‰¢â‰ ğ•¨ ?
        ".out"âˆ¾Ëœğ•©âˆ¾"."âˆ¾(âˆ¾âŸœ"_"âŠ¸âˆ¾)Â´ğ•¨ ;
        ğ•©âˆ¾".out"
    } path
}

# Runs AHD on the given source file with the given arguments and records the
# result to the output directory.
# ğ•©: string - file name (without the directory path.)
# ğ•¨: string list - arguments to AHD.
Record â† {
    sourceFile â† sourceDirectory â€¢file.At ğ•©
    outputFile â† ğ•¨ OutputFile ğ•©

    report â† GenerateReport RunAHD ğ•¨âˆ¾<sourceFile

    â€¢Out "Saving output to '"âˆ¾outputFileâˆ¾"'..."
    outputFile â€¢file.Chars report
}

# TODO: make print offending line.
# Runs AHD on the given source file with the given arguments and compares it
# against the previously recorded result from the output directory.
# ğ•©: string - file name (without the directory path.)
# ğ•¨: string list - arguments to AHD.
Test â† {
    sourceFile â† sourceDirectory â€¢file.At ğ•©
    outputFile â† ğ•¨ OutputFile ğ•©

    report â† GenerateReport RunAHD ğ•¨âˆ¾<sourceFile
    previousReport â† â€¢file.Chars outputFile

    outputFile { â‰¡Â´ğ•© ?
        â€¢Out "Test passed" ;
        â€¢Out "Test failed: output differs from previously recorded output in '"âˆ¾ğ•¨âˆ¾"'"
        â€¢Out "Actual output:"
        â€¢Out âŠ‘ğ•©
        â€¢Exit 1
    } reportâ€¿previousReport
}

# To be used on Record or Test. Specifies the inputs to be recorded/tested.
# ğ”½: Record or Test.
_run â† {
    sourceFiles â† â€¢file.List sourceDirectory

    # Positive tests.
    âŸ¨âŸ©âŠ¸ğ”½Â¨ sourceFiles
    âŸ¨"--code-generator","c"âŸ©âŠ¸ğ”½Â¨ sourceFiles

    # Negative tests.
    âŸ¨"--code-generator"âŸ© ğ”½ "no-language-specified"
    âŸ¨"--code-generator","unsupported"âŸ© ğ”½ "unsupported-language"
    âŸ¨âŸ© ğ”½ "nonexistant-file"
    âŸ¨"file2"âŸ© ğ”½ "duplicate-files"
}

main â† {
    âŠ‘â€¢argsâˆŠËœ<"record" ? Record _run ; Test _run
}
